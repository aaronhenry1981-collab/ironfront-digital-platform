name: Deploy to Iron Front Digital (Prod)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::055357411476:role/ifd-github-deploy
          aws-region: us-east-2

      - name: Deploy via SSM
        env:
          INSTANCE_ID: i-0160b2a838a432bbc
          REPO: aaronhenry1981-collab/ironfront-digital-platform
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          CMD_ID=$(aws ssm send-command \
            --region us-east-2 \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"set -euo pipefail\",
              \"sudo mkdir -p /opt/ifd-app /opt/ifd-deploy /opt/ifd-data\",
              \"sudo chown -R ec2-user:ec2-user /opt/ifd-app /opt/ifd-deploy /opt/ifd-data\",
              \"cd /tmp\",
              \"rm -rf ironfront-digital-platform || true\",
              \"git clone https://github.com/$REPO.git ironfront-digital-platform\",
              \"cd ironfront-digital-platform\",
              \"rsync -a --delete app/ /opt/ifd-app/\",
              \"rsync -a --delete deploy/ /opt/ifd-deploy/\",
              \"chmod +x /opt/ifd-deploy/deploy.sh\",
              \"cd /opt/ifd-app\",
              \"APP_VERSION=$SHA /opt/ifd-deploy/deploy.sh\"
            ]" \
            --comment "IFD prod deploy $SHA" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Waiting for deployment to complete..."
          sleep 10
          
          # Wait for command to complete
          aws ssm wait command-executed \
            --region us-east-2 \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" || true
          
          # Check command status
          STATUS=$(aws ssm get-command-invocation \
            --region us-east-2 \
            --command-id "$CMD_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "Status" \
            --output text)
          
          if [[ "$STATUS" != "Success" ]]; then
            echo "Deployment failed with status: $STATUS"
            aws ssm get-command-invocation \
              --region us-east-2 \
              --command-id "$CMD_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}" \
              --output json
            exit 1
          fi
          
          echo "Deployment successful"
